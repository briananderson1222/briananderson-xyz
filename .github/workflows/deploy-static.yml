name: Deploy Site (Static Only)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      invalidate_cache:
        description: 'Invalidate Cloud CDN Cache'
        required: false
        default: false
        type: boolean

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Validate
        working-directory: site
        env:
          PUBLIC_POSTHOG_KEY: ${{ secrets.PUBLIC_POSTHOG_KEY }}
          PUBLIC_POSTHOG_HOST: ${{ secrets.PUBLIC_POSTHOG_HOST }}
        run: pnpm run validate

  deploy-site:
    environment: prod
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Build
        working-directory: site
        env:
          PUBLIC_POSTHOG_KEY: ${{ secrets.PUBLIC_POSTHOG_KEY }}
          PUBLIC_POSTHOG_HOST: ${{ secrets.PUBLIC_POSTHOG_HOST }}
        run: pnpm build
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Upload to GCS
        run: |
          gcloud storage rsync site/build gs://${{ secrets.GCS_BUCKET }} --recursive --delete-unmatched-destination-objects
          gcloud storage buckets update gs://${{ secrets.GCS_BUCKET }} --web-main-page-suffix=index.html --web-error-page=404.html
          gcloud storage buckets add-iam-policy-binding gs://${{ secrets.GCS_BUCKET }} --member=allUsers --role=roles/storage.objectViewer
      - name: Invalidate Cloud CDN Cache
        if: ${{ inputs.invalidate_cache == true }}
        run: |
          # Requires GCS_CDN_URL_MAP_NAME secret to be set in GitHub
          if [ -n "${{ secrets.GCS_CDN_URL_MAP_NAME }}" ]; then
            gcloud compute url-maps invalidate-cdn-cache ${{ secrets.GCS_CDN_URL_MAP_NAME }} --path "/*" --async
          else
            echo "Skipping invalidation: GCS_CDN_URL_MAP_NAME secret not set."
            echo "If you are using Cloudflare, configure this step to call the Cloudflare API instead."
          fi
