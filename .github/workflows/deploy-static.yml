name: Deploy Site (Static Only)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-site:
    environment: prod
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Build
        working-directory: site
        run: pnpm build
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Upload to GCS
        run: |
          gsutil -m rsync -r site/build gs://${{ secrets.GCS_BUCKET }}
          gsutil web set -m index.html -e 404.html gs://${{ secrets.GCS_BUCKET }}
          gsutil iam ch allUsers:objectViewer gs://${{ secrets.GCS_BUCKET }}