name: Build and Deploy (Site + Auth Proxy)

on:
  push:
    branches: [ "main" ]

jobs:
  build-site:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Build
        working-directory: site
        run: pnpm build
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to GCS
        run: |
          gsutil -m rsync -r site/build gs://${{ secrets.GCS_BUCKET }}
          gsutil web set -m index.html -e 404.html gs://${{ secrets.GCS_BUCKET }}
          gsutil iam ch allUsers:objectViewer gs://${{ secrets.GCS_BUCKET }}

  deploy-auth-proxy:
    runs-on: ubuntu-latest
    needs: build-site
    steps:
      - uses: actions/checkout@v4
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      - name: Build and push image
        run: |
          gcloud builds submit auth-proxy --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/decap-auth-proxy:latest
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy decap-auth-proxy             --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/decap-auth-proxy:latest             --region ${{ secrets.GCP_REGION }}             --platform managed             --allow-unauthenticated             --update-env-vars GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }},GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }},BASE_URL=${{ secrets.AUTH_PROXY_BASE_URL }}
