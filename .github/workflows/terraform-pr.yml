name: Terraform Validate & Plan (PR)

on:
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Check if secrets are available
        id: check-secrets
        run: |
          if [ -n "${{ secrets.GCP_WIF_PROVIDER }}" ] && [ -n "${{ secrets.GCP_WIF_SA_EMAIL }}" ]; then
            echo "secrets-available=true" >> $GITHUB_OUTPUT
            echo "âœ… GCP secrets are available - full validation will be performed"
          else
            echo "secrets-available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  GCP secrets not available (external PR) - performing limited validation"
          fi

      - name: Authenticate to Google Cloud (WIF)
        if: steps.check-secrets.outputs.secrets-available == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}

      - name: Terraform Format Check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init (Local backend for external PRs)
        if: steps.check-secrets.outputs.secrets-available == 'false'
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Init (GCS backend for internal PRs)
        if: steps.check-secrets.outputs.secrets-available == 'true'
        working-directory: infra/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="prefix=gcp/infra"

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Plan (Full - Internal PR)
        if: steps.check-secrets.outputs.secrets-available == 'true'
        id: plan-full
        working-directory: infra/terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="github_org=${{ secrets.GH_ORG }}" \
            -var="github_repo=${{ secrets.GH_REPO }}" \
            -var="bucket_name=${{ secrets.SITE_BUCKET_NAME }}" \
            -var="auth_proxy_domain=${{ secrets.AUTH_PROXY_DOMAIN }}" \
            -out=tfplan.out

      - name: Show Plan (Internal PR)
        if: steps.check-secrets.outputs.secrets-available == 'true'
        working-directory: infra/terraform
        run: terraform show -no-color tfplan.out

      - name: Terraform Plan (Syntax Check - External PR)
        if: steps.check-secrets.outputs.secrets-available == 'false'
        working-directory: infra/terraform
        run: |
          echo "ðŸ” Performing syntax validation for external PR..."
          terraform plan \
            -var="project_id=dummy-project" \
            -var="region=us-central1" \
            -var="github_org=dummy-org" \
            -var="github_repo=dummy-repo" \
            -var="bucket_name=dummy-bucket" \
            -var="auth_proxy_domain=dummy.example.com" \
            -out=tfplan-syntax.out || echo "âš ï¸  Plan failed as expected for external PR - this validates syntax only"

      - name: Comment PR (External PR)
        if: steps.check-secrets.outputs.secrets-available == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” Terraform Validation Results (External PR)
              
              âœ… **Terraform Format Check**: Passed
              âœ… **Terraform Validate**: Passed  
              âœ… **Terraform Syntax Check**: Completed
              
              > **Note**: This is an external PR, so full terraform planning with GCP backend access was skipped for security reasons. The validation above confirms that your terraform syntax and configuration structure are correct.
              
              A maintainer will review your changes and run the full validation if needed.`
            })

      - name: Comment PR (Internal PR)
        if: steps.check-secrets.outputs.secrets-available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Terraform Validation Results (Internal PR)
              
              âœ… **Terraform Format Check**: Passed
              âœ… **Terraform Validate**: Passed  
              âœ… **Terraform Plan**: Completed with GCP backend access
              
              Full terraform plan has been executed and validated against the remote state.`
            })
