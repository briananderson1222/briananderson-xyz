name: Build and Deploy

permissions:
  contents: read
  id-token: write

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_prod:
        description: 'Deploy to production (default: dev only)'
        required: false
        default: false
        type: boolean
      rollback:
        description: 'Rollback to previous successful deployment'
        required: false
        default: false
        type: boolean
      target_env:
        description: 'Target environment for rollback (dev or prod)'
        required: false
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Create .env file (Prod for validation)
        working-directory: site
        run: |
          echo "PUBLIC_SITE_URL=https://briananderson.xyz" > .env
          echo "PUBLIC_POSTHOG_KEY=${{ secrets.PUBLIC_POSTHOG_KEY }}" >> .env
          echo "PUBLIC_POSTHOG_HOST=${{ secrets.PUBLIC_POSTHOG_HOST }}" >> .env
      - name: Run validation
        working-directory: site
        run: pnpm run validate

  deploy-dev:
    runs-on: ubuntu-latest
    needs: validate
    environment: dev
    if: github.event.inputs.rollback != 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Install Playwright browsers
        working-directory: site
        run: npx playwright install chromium
      - name: Create .env file (Dev)
        working-directory: site
        run: |
          echo "PUBLIC_SITE_URL=https://dev.briananderson.xyz" > .env
          echo "PUBLIC_POSTHOG_KEY=${{ secrets.PUBLIC_POSTHOG_KEY }}" >> .env
          echo "PUBLIC_POSTHOG_HOST=${{ secrets.PUBLIC_POSTHOG_HOST }}" >> .env
      - name: Build for Dev
        working-directory: site
        run: pnpm run build
      - name: Upload dev build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-dev
          path: site/build/
          retention-days: 14
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Get last successful dev deployment
        id: last_successful
        run: |
          LAST_SUCCESSFUL=$(gh run list --workflow=build-and-deploy.yml --branch=main --limit=100 --json conclusion,name,databaseId --jq '[.[] | select(.conclusion == "success" and .name == "deploy-dev")] | .[0].databaseId' || echo "none")
          if [ "$LAST_SUCCESSFUL" == "none" ] || [ -z "$LAST_SUCCESSFUL" ]; then
            echo "No previous successful dev deployment found"
            echo "run_id=none" >> $GITHUB_OUTPUT
          else
            echo "run_id=$LAST_SUCCESSFUL" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Upload to dev bucket
        run: |
          gcloud storage rsync site/build/ gs://dev.briananderson.xyz/ --delete-unmatched-destination-objects
          gcloud storage buckets update gs://dev.briananderson.xyz --web-main-page-suffix=index.html --web-error-page=index.html
      - name: Run E2E tests
        id: smoke
        working-directory: site
        env:
          PLAYWRIGHT_TEST_BASE_URL: https://dev.briananderson.xyz
        run: pnpm run test:e2e
      - name: Rollback on failure
        if: steps.smoke.outcome == 'failure' && steps.last_successful.outputs.run_id != 'none'
        env:
          LAST_RUN_ID: ${{ steps.last_successful.outputs.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "❌ Smoke tests failed, rolling back dev to run $LAST_RUN_ID..."
          gh run download $LAST_RUN_ID -n build-artifact-dev
          gcloud storage rsync site/build/ gs://dev.briananderson.xyz/ --delete-unmatched-destination-objects
          echo "Rollback complete."
          exit 1

  deploy-prod:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: prod
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_prod == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: site/pnpm-lock.yaml
      - name: Install deps
        working-directory: site
        run: pnpm i --frozen-lockfile || pnpm i
      - name: Install Playwright browsers
        working-directory: site
        run: npx playwright install chromium
      - name: Create .env file (Prod)
        working-directory: site
        run: |
          echo "PUBLIC_SITE_URL=https://briananderson.xyz" > .env
          echo "PUBLIC_POSTHOG_KEY=${{ secrets.PUBLIC_POSTHOG_KEY }}" >> .env
          echo "PUBLIC_POSTHOG_HOST=${{ secrets.PUBLIC_POSTHOG_HOST }}" >> .env
      - name: Build for Prod
        working-directory: site
        run: pnpm run build
      - name: Upload prod build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-prod
          path: site/build/
          retention-days: 30
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Get last successful prod deployment
        id: last_successful
        run: |
          LAST_SUCCESSFUL=$(gh run list --workflow=build-and-deploy.yml --branch=main --limit=100 --json conclusion,name,databaseId --jq '[.[] | select(.conclusion == "success" and .name == "deploy-prod")] | .[0].databaseId' || echo "none")
          if [ "$LAST_SUCCESSFUL" == "none" ] || [ -z "$LAST_SUCCESSFUL" ]; then
            echo "No previous successful prod deployment found"
            echo "run_id=none" >> $GITHUB_OUTPUT
          else
            echo "run_id=$LAST_SUCCESSFUL" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Upload to prod bucket
        id: deploy
        run: |
          gcloud storage rsync site/build/ gs://briananderson.xyz/ --delete-unmatched-destination-objects
          gcloud storage buckets update gs://briananderson.xyz --web-main-page-suffix=index.html --web-error-page=index.html
      - name: Run smoke tests
        id: smoke
        working-directory: site
        env:
          PLAYWRIGHT_TEST_BASE_URL: https://briananderson.xyz
        run: pnpm run test:e2e
      - name: Rollback on failure
        if: steps.smoke.outcome == 'failure' && steps.last_successful.outputs.run_id != 'none'
        env:
          LAST_RUN_ID: ${{ steps.last_successful.outputs.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "❌ Smoke tests failed, rolling back prod to run $LAST_RUN_ID..."
          gh run download $LAST_RUN_ID -n build-artifact-prod
          gcloud storage rsync site/build/ gs://briananderson.xyz/ --delete-unmatched-destination-objects
          echo "Rollback complete."
          exit 1
      - name: Warn if no rollback target
        if: steps.smoke.outcome == 'failure' && steps.last_successful.outputs.run_id == 'none'
        run: |
          echo "⚠️  Smoke tests failed but no previous successful prod deployment found for rollback."
          echo "This is the first prod deployment - manual intervention may be required."
          exit 1

  rollback-manual:
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback == 'true'
    environment: ${{ github.event.inputs.target_env }}
    steps:
      - uses: actions/checkout@v4
      - name: Get last successful deployment
        id: last_successful
        run: |
          TARGET_ENV="${{ github.event.inputs.target_env }}"
          LAST_SUCCESSFUL=$(gh run list --workflow=build-and-deploy.yml --branch=main --limit=100 --json conclusion,name,databaseId --jq '[.[] | select(.conclusion == "success" and .name == "deploy-'$TARGET_ENV'")] | .[0].databaseId' || echo "none")
          if [ "$LAST_SUCCESSFUL" == "none" ] || [ -z "$LAST_SUCCESSFUL" ]; then
            echo "No previous successful deployment found for $TARGET_ENV"
            echo "run_id=none" >> $GITHUB_OUTPUT
          else
            echo "run_id=$LAST_SUCCESSFUL" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Check if rollback target exists
        if: steps.last_successful.outputs.run_id == 'none'
        run: |
          echo "❌ No previous successful deployment found for rollback."
          exit 1
      - name: Download artifact
        env:
          GH_TOKEN: ${{ github.token }}
          TARGET_ENV: ${{ github.event.inputs.target_env }}
        run: |
          RUN_ID=${{ steps.last_successful.outputs.run_id }}
          ARTIFACT_NAME="build-artifact-$TARGET_ENV"
          echo "Downloading $ARTIFACT_NAME from run $RUN_ID..."
          gh run download $RUN_ID -n $ARTIFACT_NAME --dir site/build/
      - name: Verify artifact download
        run: |
          echo "Files in site/build/:"
          find site/build -type f | wc -l
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Rollback to ${{ github.event.inputs.target_env }}
        run: |
          BUCKET="dev.briananderson.xyz"
          if [ "${{ github.event.inputs.target_env }}" == "prod" ]; then
            BUCKET="briananderson.xyz"
          fi
          gcloud storage rsync site/build/ gs://$BUCKET/ --delete-unmatched-destination-objects
          echo "✅ Rollback to ${{ github.event.inputs.target_env }} complete"
